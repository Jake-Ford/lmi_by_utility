---
title: "LMI Population Spatial Analysis"
author: "Jacob Ford"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmdformats::downcute:
    toc_depth: 2
---


# Overview

This document quantifies the number of LMI households by utility zone in select states. We use state specific LMI definitions and overlay utility zones to estimate the LMI population covered. 

Utility coverage is provided by either the [HIFLD](https://hifld-geoplatform.opendata.arcgis.com/datasets/f4cd55044b924fed9bc8b64022966097/explore?location=41.065293%2C-80.583661%2C6.90) national level electric retail service territories or, preferably, state sources that are more granular. Note HIFLD often provides overlapping areas (ex: a municipal boundary and an utility provider) so data should primarily be sourced from state sources or be validated from HIFLD. 




```{r message=FALSE, warning=FALSE, include=FALSE}
#Load packages we'll need throughout the entire document
library(readxl)
library(sf)
library(dplyr)
library(scales)
library(tidycensus)
library(tidyverse)
options(tigris_use_cache = TRUE)
library(nngeo)
library(leaflet)
library(janitor)
library(DT)
library(kableExtra)
library(ggmap)
source('helper_functions.R')
library(RColorBrewer)

options(scipen = 100)

```


# Summary Tables

```{r message=FALSE, warning=FALSE, include=FALSE}

state_list <- c("IL", "NM", "MA", "NY", "NJ", "MN")

hifld_df <- st_read("utility_zones/HIFLD/Electric_Retail_Service_Territories (1)/Electric_Retail_Service_Territories.shp") %>%
  filter(STATE %in% state_list)

get_tracts <- get_acs(
  geography="tract", 
  state=state_list,
  variables=c("Median Income" = "S1901_C01_012E"),
  year=2017, 
  geometry=TRUE) %>%
  mutate(MedInc = estimate) %>%
  select(geoid=GEOID, geometry)


```








```{r message=FALSE, warning=FALSE, include=FALSE}
chas_df <- load_chas() %>%
    mutate(State_Name = case_when(
    state == 17 ~ "Illinois",
    state == 25 ~ "Massachusetts",  
    state == 27 ~ "Minnesota",  
    state == 34 ~ "New Jersey",
    state == 35 ~ "New Mexico",  
    state == 36 ~ "New York",
    TRUE ~ "Other"
  ))



add_geo <- merge(chas_df, get_tracts) 

add_geo <- st_as_sf(add_geo)

add_geo <- add_geo %>%
  filter(State_Name=="New Mexico")

hifld_df <- st_transform(hifld_df, st_crs(add_geo)) %>%
  st_make_valid()
```







## New Mexico


LMI Qualification: 

  * Medicaid
  * SNAP
  * LIHEAP
  * First-time home owner programs
  * Affordable housing facilities
    - HUD data: https://resources.hud.gov/#layers-menu
    - state specific to supplement: https://housingnm.org/find-housing/rentals/affordable
  * Low-income housing
  * State and federal income tax credit
  * Entire multi-family housing project may qualify if the entire load can be proved to be low-income subscribers, with consent of all tenants of record.
  * *LMI - 80% of AMI*
  
  
  
```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

  # * Medicaid
  #   - total count of population with Medicaid- C27007_004 + C27007_007 + C27007_010 + C27007_014 + C27007_017 + C27007_020
  #   - geo: tract
  #   
  # * SNAP
  #   - total count of HH received Food Stamps/SNAP in last 12 months - B22001_002
  #   - total count of population received Food Stamps/SNAP in last 12 months - B19058_002
  #   - geo: tract
  # * LIHEAP
  #   - use this to calculate income by self attestation? 
  #   https://www.acf.hhs.gov/sites/default/files/documents/ocs/comm_liheap_im2002smiattachment_fy2021.pdf
  #   
  # * first-time home owner programs
  # * affordable housing facilities
  #   - HUD data: https://resources.hud.gov/#layers-menu
  #   - state specific to supplement: https://housingnm.org/find-housing/rentals/affordable
  # * low-income housing
  # * state and federal income tax credit
  # * entire multi-family housing project may qualify if the entire load can be proved to be low-income subscribers, with consent of all tenants of record.
  # 
  # LMI - 80% of AMI from HUD..
acs_vars <- load_variables(2019, "acs5")
```

```{r message=FALSE, warning=FALSE, include=FALSE}
nm_blocks <- get_acs(
  geography="tract", 
  state="NM",
  variables=c("snap_hh" = "B22001_002",
              "snap_pop" = "B19058_002",
              "medicaid_1" = "C27007_004",
              "medicaid_2" = "C27007_007",
              "medicaid_3" = "C27007_010",
              "medicaid_4" = "C27007_014",
              "medicaid_5" = "C27007_017",
              "medicaid_6" = "C27007_020"
              
              ),
  year=2019, 
  geometry=TRUE) %>%
  group_by(GEOID) %>%
  summarize(snap_hh = estimate[variable=="snap_pop"],
            medicaid_pop =estimate[variable=="medicaid_1"] + 
                          estimate[variable=="medicaid_2"] +
                          estimate[variable=="medicaid_3"] +
                          estimate[variable=="medicaid_4"] +
                          estimate[variable=="medicaid_5"] +
                          estimate[variable=="medicaid_6"] )

total_nm_tracts <- cbind(add_geo, nm_blocks)


nm_blocks
```




```{r echo=FALSE, message=FALSE, warning=FALSE}

temp_util <- hifld_df %>%
  filter(ID %in% c(15473, 10817)) %>%
  mutate(new_name = case_when(
    ID == 15473 ~ "Public Service Company",
    ID == 10817 ~ "Xcel"
  ))

temp <- total_nm_tracts %>% 
  st_point_on_surface() %>%
  st_make_valid() %>%
  st_join(temp_util %>% select(NAME)) %>%
  st_drop_geometry() %>%
  group_by(Name = NAME) %>%
  filter(!is.na(Name)) %>%
  summarize(`Pop under 80 AMI` = sum(AMI_80),
            `Medicaid` = sum(medicaid_pop),
            `SNAP` = sum(snap_hh),
            `Total` = sum(Total_Pop)) %>%
  arrange(desc(`Pop under 80 AMI`)) %>%
  adorn_totals("row") 

datatable(temp, caption = "New Mexico, Sources: ACS 2019 and HUD CHAS")%>%
  formatCurrency('Pop under 80 AMI',currency = "", interval = 3, mark = ",") %>%
  formatCurrency('Medicaid',currency = "", interval = 3, mark = ",") %>%
  formatCurrency('SNAP',currency = "", interval = 3, mark = ",") %>%
  formatCurrency('Total',currency = "", interval = 3, mark = ",") 





```




```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=8}

nm_df <- add_geo %>%
  filter(State_Name == "New Mexico") 

pal <- colorNumeric(
  palette = "Reds",
 # reverse=TRUE,
  domain = nm_df$AMI_80)

pal2 <- colorNumeric(
  palette = "Purples",
 # reverse=TRUE,
  domain = nm_df$AMI_80_Pct)

pal3 <- colorNumeric(
  palette = "Greens",
 # reverse=TRUE,
  domain = nm_blocks$snap_hh)

pal4 <- colorNumeric(
  palette = "Blues",
 # reverse=TRUE,
  domain = nm_blocks$medicaid_pop)
 
# 15473 Public Service
# 10817 Xcel
temp_util <- hifld_df %>%
  filter(ID %in% c(15473, 10817)) %>%
  mutate(new_name = case_when(
    ID == 15473 ~ "Public Service Company",
    ID == 10817 ~ "Xcel"
  ))


map <- leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=temp_util,
              group="Utility Zone",
              stroke=TRUE,
              color="black",
              dashArray="3",
              fillOpacity=0,
              popup=paste("Utility Zone: ", temp_util$new_name)
  ) %>%
  
  addPolygons(
    data = nm_df,
    group="80% AMI Count",  # This should be consistent with the group name in the addLegend function
    stroke=FALSE,
    smoothFactor=0.2,
    fillOpacity=0.7,
    color=~pal(AMI_80),
    popup=paste("Tract: ", nm_df$geoid, "<br>", 
                "HHs at 80% AMI: ", nm_df$AMI_80)
  ) %>%

  addLegend("bottomleft",
            group="80% AMI Count",  # This should be consistent with the group name in the addPolygons function
            pal = pal,
            values = nm_df$AMI_80,
            title="Number of HHs at 80% AMI"
  ) %>%
  
  addPolygons(
    data=nm_df,
    group="80% AMI Percent",  # This should be consistent with the group name in the addLegend function
    stroke=FALSE,
    smoothFactor=0.2,
    fillOpacity=0.7,
    color=~pal2(AMI_80_Pct),
    popup=paste("Tract: ", nm_df$geoid, "<br>", 
                "Percent of HHs at 80% AMI: ", nm_df$AMI_80_Pct)
  ) %>%
  
  addLegend("bottomleft",
            group="80% AMI Percent",  # This should be consistent with the group name in the addPolygons function
            pal = pal2,
            values = nm_df$AMI_80_Pct,
            title="Percent of HHs at 80% AMI"
  ) %>%
  
  addPolygons(
    data=nm_blocks,
    group="SNAP",
    stroke=FALSE,
    smoothFactor=0.2,
    fillOpacity=0.7,
    color=~pal3(snap_hh),
    popup=paste("Tract: ", nm_blocks$GEOID, "<br>", 
                "Number of HHs Receiving SNAP: ", nm_blocks$snap_hh)
  ) %>%
  
  addLegend("bottomleft",
            group="SNAP",
            pal = pal3,
            values = nm_blocks$snap_hh,
            title="Number of HHs Receiving SNAP:"
  ) %>%
  
  addPolygons(
    data=nm_blocks,
    group="Medicaid",
    stroke=FALSE,
    smoothFactor=0.2,
    fillOpacity=0.7,
    color=~pal4(medicaid_pop),
    popup=paste("Tract: ", nm_blocks$GEOID, "<br>", 
                "Number of HHs Receiving SNAP: ", nm_blocks$medicaid_pop)
  ) %>%
  
  addLegend("bottomleft",
            group="Medicaid",
            pal = pal4,
            values = nm_blocks$medicaid_pop,
            title="Number of HHs Receiving SNAP:"
  ) %>%
   
  addLayersControl(
    overlayGroups=c("80% AMI Percent", "80% AMI Count", "Utility Zone", "SNAP", "Medicaid"),  # Update the order for consistency
    options = layersControlOptions(collapsed = FALSE)
  )

map %>%
  hideGroup("80% AMI Percent") %>% hideGroup("SNAP") %>% hideGroup("80% AMI Count") %>% hideGroup("Medicaid")

```



```{r}
getwd()
```






## Public Housing

Take each affordable rental property listed on the [MFA Housing New Mexico](https://housingnm.org/find-housing/rentals/affordable) website. We'll calculate how many LMI populace is within various buffered boundaries of each point. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
# nm_data <- read_excel("nm_public_housing.xlsx")
# 
# 
# 
# library(ggmap)
# 
# # Assuming your 'nm_data' dataframe has columns 'Address' and 'Address 2'
# # Create a new column to store the full address (combining Address and Address 2)
# nm_data$full_address <- paste(nm_data$Address, nm_data$`Address 2`, sep = ", ")
# 
# # Use geocode() to get latitude and longitude for each address
# geocoded_data <- geocode(nm_data$full_address)
# 
# # Add latitude and longitude columns to the original dataframe
# nm_data$Latitude <- geocoded_data$lat
# nm_data$Longitude <- geocoded_data$lon
# 
# nm_data <- nm_data %>%
#   filter(!is.na(Longitude))
# 
# nm_data <- st_as_sf(nm_data, coords = c("Longitude", "Latitude"), crs = st_crs(nm_blocks))

# st_write(nm_data, "nm_public_housing.shp")

nm_public_housing <- st_read("nm_public_housing.shp")

library(leaflet.extras)


nm_pub_in_util <- nm_public_housing %>%
  st_point_on_surface() %>%
  st_join(temp_util %>% select(util_name = NAME)) %>%
  filter(!is.na(util_name))


  map %>%

  addMarkers(data=nm_public_housing,
                   group="Public Housing",
                #   color="black",
                #   radius=2,
                   popup=paste("Name: ", nm_public_housing$Name)) %>%
  addMarkers(data = nm_pub_in_util,
             group="Public Housing in Utility Zones",
           #  color="red",
            popup=paste("Name: ", nm_pub_in_util$util_name)) %>%


  addLayersControl(
    overlayGroups=c("80% AMI Percent", "80% AMI Count", "Utility Zone", "SNAP", "Medicaid", "Public Housing", "Public Housing in Utility Zones"),  # Update the order for consistency
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  hideGroup("80% AMI Percent") %>% hideGroup("SNAP") %>% hideGroup("80% AMI Count") %>% hideGroup("Medicaid") %>% hideGroup("Public Housing in Utility Zones")


```




```{r message=FALSE, warning=FALSE, include=FALSE}


nm_public_housing_buffer <- st_buffer(nm_pub_in_util, dist = 10) # 1 mile = 1609.34 meters

# Step 2: Identify census tracts that intersect with the 5-mile buffer
intersecting_tracts <- st_intersection(total_nm_tracts, nm_public_housing_buffer)



total_df <- data.frame(Measure = c("Medicaid", "SNAP", "80% AMI"),
                       Buffer_1 = c(sum(intersecting_tracts$medicaid_pop), sum(intersecting_tracts$snap_hh), sum(intersecting_tracts$AMI_80)))

nm_public_housing_buffer <- st_buffer(nm_pub_in_util, dist = 50) # 1 mile = 1609.34 meters


# Step 2: Identify census tracts that intersect with the 5-mile buffer
intersecting_tracts <- st_intersection(total_nm_tracts, nm_public_housing_buffer)



total_df$Buffer_5 <- c(sum(intersecting_tracts$medicaid_pop), sum(intersecting_tracts$snap_hh), sum(intersecting_tracts$AMI_80))


nm_public_housing_buffer <- st_buffer(nm_pub_in_util, dist = 100) # 1 mile = 1609.34 meters

# Step 2: Identify census tracts that intersect with the 5-mile buffer
intersecting_tracts <- st_intersection(total_nm_tracts, nm_public_housing_buffer)



total_df$Buffer_10 <- c(sum(intersecting_tracts$medicaid_pop), sum(intersecting_tracts$snap_hh), sum(intersecting_tracts$AMI_80))




```



```{r echo=FALSE, message=FALSE, warning=FALSE}

datatable(total_df, caption = "New Mexico Distance from Public Housing and Selected Characteristics")%>%
  formatCurrency('Buffer_1',currency = "", interval = 3, mark = ",") %>%
  formatCurrency('Buffer_5',currency = "", interval = 3, mark = ",") %>%
  formatCurrency('Buffer_10',currency = "", interval = 3, mark = ",") 


```



















